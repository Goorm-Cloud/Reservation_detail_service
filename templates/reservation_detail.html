{% extends 'base.html' %}

{% block title %}예약 정보 상세보기{% endblock %}

{% block content %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoochacha - 예약 상세 정보</title>
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_api_key }}&libraries=services"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/map_style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="{{ url_for('static', filename='js/map_script.js') }}" defer></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container {
            max-width: 800px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h2 {
            font-weight: bold;
            color: #343a40;
        }
        .table th, .table td {
            text-align: center;
        }
        .user-info {
            background-color: #d1e7dd;
        }
        .reservation-info {
            background-color: #f8d7da;
        }
        .parkinglot-info {
            background-color: #cfe2ff;
        }
        .btn-group {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h2 class="text-center mb-4">예약 정보</h2>
    
    <table class="table table-bordered table-hover bg-white">
        <thead class="table-dark">
            <tr>
                <th>항목</th>
                <th>내용</th>
            </tr>
        </thead>
        <tbody>
            {% if reservation.reservation_status %}
            <tr class="reservation-info">
                <td><strong>예약 상태</strong></td>
                <td>{{ reservation.reservation_status }}</td>
            </tr>
            {% endif %}
            {% if reservation.created_at %}
            <tr class="reservation-info">
                <td><strong>생성 일시</strong></td>
                <td>{{ reservation.created_at }}</td>
            </tr>
            {% endif %}
            {% if user.name %}
            <tr class="user-info">
                <td><strong>사용자 이름</strong></td>
                <td>{{ user.name }}</td>
            </tr>
            {% endif %}
            {% if user.email %}
            <tr class="user-info">
                <td><strong>이메일</strong></td>
                <td>{{ user.email }}</td>
            </tr>
            {% endif %}
            {% if user.phone %}
            <tr class="user-info">
                <td><strong>연락처</strong></td>
                <td>{{ user.phone }}</td>
            </tr>
            {% endif %}
            {% if parkinglot.parkinglot_name %}
            <tr class="parkinglot-info">
                <td><strong>주차장 이름</strong></td>
                <td>{{ parkinglot.parkinglot_name }}</td>
            </tr>
            {% endif %}
            {% if parkinglot.parkinglot_add %}
            <tr class="parkinglot-info">
                <td><strong>주소</strong></td>
                <td>{{ parkinglot.parkinglot_add }}</td>
            </tr>
            {% endif %}
            {% if parkinglot.parkinglot_type %}
            <tr class="parkinglot-info">
                <td><strong>주차장 유형</strong></td>
                <td>{{ parkinglot.parkinglot_type }}</td>
            </tr>
            {% endif %}
            {% if parkinglot.parkinglot_day %}
            <tr class="parkinglot-info">
                <td><strong>운영 요일</strong></td>
                <td>{{ parkinglot.parkinglot_day }}</td>
            </tr>
            {% endif %}
            {% if parkinglot.parkinglot_time %}
            <tr class="parkinglot-info">
                <td><strong>운영 시간</strong></td>
                <td>{{ parkinglot.parkinglot_time }}</td>
            </tr>
            {% endif %}
        </tbody>
    </table>

    
    <div class="btn-group mt-4">
        <a href="/map" class="btn btn-secondary">홈으로</a>
<!-- 예약 수정 버튼 (모달 트리거) -->
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editReservationModal">
    예약 수정
</button>
<button disabled onclick="confirmDeletion('{{ reservation.reservation_id }}')" class="btn btn-danger">예약 삭제</button>
</div>


<!-- 예약 수정 모달 -->
<div class="modal fade" id="editReservationModal" tabindex="-1" aria-labelledby="editReservationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editReservationModalLabel">예약 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editReservationForm">
                    <div class="mb-3">
                        <label for="reservation_status" class="form-label">예약 상태</label>
                        <input type="text" class="form-control" id="reservation_status" name="reservation_status" value="{{ reservation.reservation_status }}">
                    </div>
                    <div class="mb-3">
                        <label for="user_name" class="form-label">사용자 이름</label>
                        <input type="text" class="form-control" id="user_name" name="user_name" value="{{ user.name }}">
                    </div>
                    <div class="mb-3">
                        <label for="user_email" class="form-label">이메일</label>
                        <input type="email" class="form-control" id="user_email" name="user_email" value="{{ user.email }}">
                    </div>
                    <div class="mb-3">
                        <label for="user_phone" class="form-label">연락처</label>
                        <input type="text" class="form-control" id="user_phone" name="user_phone" value="{{ user.phone }}">
                    </div>

                    <div class="mb-3">
                        <label for="modified_by" class="form-label">수정자</label>
                        <input type="text" class="form-control" id="modified_by" name="modified_by">
                    </div>
                    <div class="mb-3">
                        <label for="modified_at" class="form-label">수정 시간</label>
                        <input type="datetime-local" class="form-control" id="modified_at" name="modified_at">
                    </div>

                    <button type="submit" class="btn btn-success">수정 완료</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 모달 저장 AJAX 요청 -->
<script>
    document.getElementById("editReservationForm").addEventListener("submit", function(event) {
        event.preventDefault();

        const formData = {
            reservation_status: document.getElementById("reservation_status").value,
            user_name: document.getElementById("user_name").value,
            user_email: document.getElementById("user_email").value,
            user_phone: document.getElementById("user_phone").value,
            modified_by: document.getElementById("modified_by").value || "관리자",
            modified_at: document.getElementById("modified_at").value ? 
            new Date(document.getElementById("modified_at").value).toISOString().slice(0, 19).replace('T', ' ') :
            new Date().toISOString().slice(0, 19).replace('T', ' ')
        };

        fetch(`/reservation-detail/{{ reservation.reservation_id }}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        }).then(response => {
            if (response.ok) {
                alert("예약 정보가 수정되었습니다.");
                location.reload();
            } else {
                alert("수정에 실패했습니다.");
            }
        });
    });
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function confirmDeletion(reservationId) {
        if (confirm('정말 삭제하시겠습니까?')) {
            fetch(`/reservations-detail/${reservationId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            }).then(response => {
                if (response.ok) {
                    alert('예약이 삭제되었습니다.');
                    window.location.href = '/map';
                } else {
                    alert('삭제에 실패했습니다.');
                }
            });
        }
    }
</script>
</body>
</html>
{% endblock %}
